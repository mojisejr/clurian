import { describe, it, expect, beforeEach, vi } from 'vitest'
import { render, screen, waitFor } from '@testing-library/react'
import userEvent from '@testing-library/user-event'
import { MixingCalculator } from '@/components/mixing/MixingCalculator'
import { MixingOrderDisplay } from '@/components/mixing/MixingOrderDisplay'
import { MixingHistory } from '@/components/mixing/MixingHistory'

// Mock dependencies
vi.mock('@/lib/mixing-calculator', () => ({
  calculateMixingOrder: vi.fn()
}))

vi.mock('@/app/actions/mixing-formulas', () => ({
  createMixingFormula: vi.fn(),
  getMixingFormulasByOrchard: vi.fn()
}))

describe('Mixing Flow Integration', () => {
  const user = userEvent.setup()

  beforeEach(() => {
    vi.clearAllMocks()
  })

  describe('MixingCalculator Component', () => {
    it('should render chemical input form', () => {
      render(<MixingCalculator />)

      expect(screen.getByText('เพิ่มสารเคมี')).toBeInTheDocument()
      expect(screen.getByPlaceholderText('ชื่อสารเคมี')).toBeInTheDocument()
      expect(screen.getByRole('button', { name: 'คำนวณลำดับการผสม' })).toBeInTheDocument()
    })

    it('should add chemical to list', async () => {
      render(<MixingCalculator />)

      const nameInput = screen.getByPlaceholderText('ชื่อสารเคมี')
      const addButton = screen.getByRole('button', { name: 'เพิ่มสารเคมี' })

      await user.type(nameInput, 'ยาทดสอบ')
      await user.click(addButton)

      expect(screen.getByText('ยาทดสอบ')).toBeInTheDocument()
    })

    it('should calculate mixing order', async () => {
      const mockCalculateMixingOrder = vi.mocked(calculateMixingOrder)
      mockCalculateMixingOrder.mockReturnValue({
        steps: [
          { step: '1', description: 'สารคีเลต/สารอินทรีย์', chemicals: [] }
        ],
        warnings: []
      })

      render(<MixingCalculator />)

      // Add a chemical first
      const nameInput = screen.getByPlaceholderText('ชื่อสารเคมี')
      const addButton = screen.getByRole('button', { name: 'เพิ่มสารเคมี' })
      await user.type(nameInput, 'ยาทดสอบ')
      await user.click(addButton)

      // Calculate order
      const calculateButton = screen.getByRole('button', { name: 'คำนวณลำดับการผสม' })
      await user.click(calculateButton)

      expect(mockCalculateMixingOrder).toHaveBeenCalled()
    })

    it('should validate chemical input before adding', async () => {
      render(<MixingCalculator />)

      // Try to add chemical without name
      const addButton = screen.getByRole('button', { name: 'เพิ่มสารเคมี' })
      await user.click(addButton)

      expect(screen.getByText('กรุณากรอกชื่อสารเคมี')).toBeInTheDocument()
    })

    it('should remove chemical from list', async () => {
      render(<MixingCalculator />)

      // Add chemical first
      const nameInput = screen.getByPlaceholderText('ชื่อสารเคมี')
      const addButton = screen.getByRole('button', { name: 'เพิ่มสารเคมี' })
      await user.type(nameInput, 'ยาทดสอบ')
      await user.click(addButton)

      // Remove chemical
      const removeButton = screen.getByRole('button', { name: 'ลบ' })
      await user.click(removeButton)

      expect(screen.queryByText('ยาทดสอบ')).not.toBeInTheDocument()
    })
  })

  describe('MixingOrderDisplay Component', () => {
    it('should display mixing steps', () => {
      const mockSteps = [
        { step: '1', description: 'สารคีเลต/สารอินทรีย์', chemicals: [
          { name: 'EDTA', quantity: 100, unit: 'g' }
        ]}
      ]

      render(<MixingOrderDisplay steps={mockSteps} warnings={[]} />)

      expect(screen.getByText('ขั้นที่ 1')).toBeInTheDocument()
      expect(screen.getByText('สารคีเลต/สารอินทรีย์')).toBeInTheDocument()
      expect(screen.getByText('EDTA')).toBeInTheDocument()
      expect(screen.getByText('100 g')).toBeInTheDocument()
    })

    it('should display warnings', () => {
      const warnings = ['ละลายยาที่เป็นผงในน้ำเล็กน้อยก่อนนำไปผสม']

      render(<MixingOrderDisplay steps={[]} warnings={warnings} />)

      expect(screen.getByText('⚠️ คำเตือน')).toBeInTheDocument()
      expect(screen.getByText(warnings[0])).toBeInTheDocument()
    })

    it('should handle empty steps', () => {
      render(<MixingOrderDisplay steps={[]} warnings={[]} />)

      expect(screen.getByText('ไม่มีขั้นตอนการผสม')).toBeInTheDocument()
    })
  })

  describe('MixingHistory Component', () => {
    const mockFormulas = [
      {
        id: 'formula-1',
        name: 'สูตรพื้นฐาน',
        description: 'สูตรสำหรับการป้องกันโรคพืชฐาน',
        usedCount: 5,
        createdAt: new Date('2024-01-01')
      },
      {
        id: 'formula-2',
        name: 'สูตรพิเศษ',
        description: 'สูตรสำหรับโรครุนแรง',
        usedCount: 3,
        createdAt: new Date('2024-01-15')
      }
    ]

    it('should display formula list', async () => {
      const mockGetFormulas = vi.mocked(getMixingFormulasByOrchard)
      mockGetFormulas.mockResolvedValue({ success: true, data: mockFormulas })

      render(<MixingHistory orchardId="test-orchard" />)

      await waitFor(() => {
        expect(screen.getByText('สูตรพื้นฐาน')).toBeInTheDocument()
        expect(screen.getByText('สูตรพิเศษ')).toBeInTheDocument()
      })
    })

    it('should handle empty formula list', async () => {
      const mockGetFormulas = vi.mocked(getMixingFormulasByOrchard)
      mockGetFormulas.mockResolvedValue({ success: true, data: [] })

      render(<MixingHistory orchardId="test-orchard" />)

      await waitFor(() => {
        expect(screen.getByText('ไม่มีสูตรที่บันทึกไว้')).toBeInTheDocument()
      })
    })
  })

  describe('Complete User Flow', () => {
    it('should create and save a formula', async () => {
      const mockCalculateMixingOrder = vi.mocked(calculateMixingOrder)
      const mockCreateFormula = vi.mocked(createMixingFormula)
      const mockGetFormulas = vi.mocked(getMixingFormulasByOrchard)

      mockCalculateMixingOrder.mockReturnValue({
        steps: [
          { step: '1', description: 'สารคีเลต/สารอินทรีย์', chemicals: [
            { name: 'EDTA', quantity: 100, unit: 'g', type: 'chelator' }
          ]}
        ],
        warnings: []
      })

      mockCreateFormula.mockResolvedValue({
        success: true,
        data: {
          id: 'new-formula',
          name: 'สูตรใหม่',
          description: 'สูตรที่สร้างใหม่'
        }
      })

      mockGetFormulas.mockResolvedValue({ success: true, data: [] })

      // Simulate user flow
      render(<MixingCalculator />)

      // 1. Add chemical
      await user.type(screen.getByPlaceholderText('ชื่อสารเคมี'), 'EDTA')
      await user.click(screen.getByRole('button', { name: 'เพิ่มสารเคมี' }))

      // 2. Calculate order
      await user.click(screen.getByRole('button', { name: 'คำนวณลำดับการผสม' }))

      // 3. Verify result displayed
      await waitFor(() => {
        expect(screen.getByText('EDTA')).toBeInTheDocument()
      })

      // 4. Save formula
      await user.click(screen.getByRole('button', { name: 'บันทึกเป็นสูตร' }))
      await user.type(screen.getByPlaceholderText('ชื่อสูตร'), 'สูตรใหม่')
      await user.click(screen.getByRole('button', { name: 'บันทึกสูตร' }))

      // Verify formula was created
      await waitFor(() => {
        expect(mockCreateFormula).toHaveBeenCalled()
      })
    })
  })
})